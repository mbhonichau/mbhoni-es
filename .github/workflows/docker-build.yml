name: Build & Push Docker Images

# Trigger on push or PR to main
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout your code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Java 21
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Build all JARs
      - name: Build JAR files
        run: |
          echo "Building config-server..."
          mvn -B package -f config-server/pom.xml
          echo "Building eureka-server..."
          mvn -B package -f eureka-server/pom.xml
          echo "Building admin-service..."
          mvn -B package -f admin-service/pom.xml
          echo "Building content-management-service..."
          mvn -B package -f content-management-service/pom.xml

      # 4. Log in to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 5. Build & Push each Docker image
      - name: Build and push config-server
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/mbhoni-config-server:latest ./config-server
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/mbhoni-config-server:latest

      - name: Build and push eureka-server
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/mbhoni-eureka-server:latest ./eureka-server
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/mbhoni-eureka-server:latest

      - name: Build and push admin-service
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/mbhoni-admin-service:latest ./admin-service
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/mbhoni-admin-service:latest

      - name: Build and push content-management-service
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/mbhoni-content-service:latest ./content-management-service
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/mbhoni-content-service:latest